= Design Patterns - TD
J.-M. Bruel <jbruel@gmail.com>
v20.1 {localdate}
:tdnum: TD2
:imagesdir: images
:sourcedir: src
:uk!:
//------------------------- variables de configuration
// only used when master document
:icons: font
:experimental:
:numbered!:
:status:
:baseURL: https://github.com/LP-APSIO/MobileModeling2020
:github: https://github.com[GitHub]
:asciidoctorlink: http://asciidoctor.org/[Asciidoctor]indexterm:[Asciidoctor]
:asciidoc: http://www.methods.co.nz/asciidoc[AsciiDoc]indexterm:[AsciiDoc]
// Specific to GitHub
ifdef::env-github[]
:tip-caption: :bulb:
:note-caption: :information_source:
:important-caption: :heavy_exclamation_mark:
:caution-caption: :fire:
:warning-caption: :warning:
endif::[]
//------------------------------------ 
ifdef::uk[]
:lang: uk
:lastName: LAST NAME
:firstName: First Name
:group: Group
:example: Example
:Enseignants: Teachers
:principe: Good design principle
:assignment: Assignment info
:requirements: Requirements
:initial: Initial tasks
:allerPlusLoin: Still hungry?...
:about: About...
endif::[]
ifndef::uk[]
:lang: fr
:lastName: NOM
:firstName: Prénom
:group: Groupe
:example: Exemple
:Enseignants: Enseignants
:principe: Principe Objet
:assignment: Informations générales
:requirements: Pré-requis
:initial: Tâche initiale
:allerPlusLoin: Pour Aller plus loin...
:about: À propos...
endif::[]
:java: https://www.java.com/fr/[Java]
//------------------------------------ 

ifdef::uk[]
== {tdnum} initial code
This is a template for the students' assignments.

ifndef::backend-pdf[]
TIP: Course material: pass:[<i class="fa fa-mobile"></i> <i class="fa fa-tablet"></i> <i class="fa fa-laptop"></i>] http://bit.ly/jmb-cpoa
endif::[]

ifdef::backend-pdf[]
TIP: Course material: icon:mobile[] icon:tablet[] icon:laptop[] http://bit.ly/jmb-cpoa
endif::[]
endif::[]

ifndef::uk[]
== Code initial pour le {tdnum}

ifndef::backend-pdf[]
TIP: Rappel du cours : pass:[<i class="fa fa-mobile"></i> <i class="fa fa-tablet"></i> <i class="fa fa-laptop"></i>] http://bit.ly/jmb-cpoa
endif::[]

ifdef::backend-pdf[]
TIP: Rappel du cours : icon:mobile[] icon:tablet[] icon:laptop[] http://bit.ly/jmb-cpoa
endif::[]

endif::[]


//------------------------------------ 
== {assignment}

{lastName}:: DOE

{firstName}:: John

{group} #::

[%interactive]
- [ ] {Enseignants}
- [ ] 1
- [ ] 2
- [ ] 3
- [x] 4
- [ ] Innopolis

//------------------------------------ 
== {requirements}

ifdef::uk[]
You'll need:

[%interactive]
* [x] A {Github} account  
* [ ] A https://gitforwindows.org/[Git Bash] terminal (if you use Window$)
endif::[]
ifndef::uk[]
Il vous faut :

[%interactive]
* [x] Un compte {Github}  
* [ ] Un terminal de type https://gitforwindows.org/[Git Bash]  (si vous utilisez Window$)
endif::[]

ifdef::uk[]
[TIP]
====    
Try the following command in your terminal to check your `git` environment:
endif::[]
ifndef::uk[]
[TIP]
====    
Essayez la commande suivante dans votre terminal pour vérifier votre environnement `git` :
endif::[]

[source,shell]
....
git config --global -l
....
====

//------------------------------------ 
== {initial}

ifdef::uk[]
[%interactive]
* [x] Click on the Github Classroom link provided by your teacher (in fact, this should be done if you read this).
* [ ] Clone on your machine the Github project generated by Github Classroom.  
* [ ] Modify the README file to add your last name, first name and group number. 
* [ ] Commit and push using the following message:
endif::[]
ifndef::uk[]
[%interactive]
* [x] Clickez sur le lien Github Classroom fourni par votre enseignant (en fait c'est déjà fait si vous lisez ces lignes).
* [ ] Clonez sur votre machine le projet Github généré pour vous par Github Classroom.  
* [ ] Modifez le `README` pour modifier Nom, Prénom et Groupe. 
* [ ] Commit & push:
endif::[]

ifndef::backend-pdf[.pass:[<i class="fa fa-github"></i>] commit/push]
ifdef::backend-pdf[.icon:github[] commit/push]
[source,shell]
....
fix #0 Initial task done
....

[IMPORTANT]
ifndef::uk[]
Dans la suite de ce document, à chaque fois que vous trouverez un énoncé commençant par `fix #...` vous devez vérifier que vos scripts/fichiers modifiés sont bien dans votre dépôt local en vue de committer et de pusher les modifications sur votre dépôt distant en utilisant comme message de commit cet énoncé.

[TIP]
====
- Si vous voulez vérifier que vous êtes prêt pour le `fix #0`, utilisez la commande : `make check`.
- Si vous voulez avoir la liste des ToDos de ce TP/TP, exécutez `make todos`.
====
endif::[]
ifdef::uk[]
In the following, every time you'll see à `fix #...` text, 
make sure all your files are committed, and then push your modifications in the distant repo, making sure you used the corresponding message (`fix #...`) in one of the `commit` messages.

[TIP]
====
- If you want to check that you're really ready for `fix #0`, you can run the command in your shell: `make check`.
- If you want to list the ToDos of the day, run `make todos`.
====
endif::[]

//------------------------------------ 
//------------------------------------ 
//------------------------------------ 
//------------  Let's START----------- 
//------------------------------------ 
//------------------------------------ 



:numbered:
== La fabrique de chocolats

[NOTE]
=====
Les exercices de ce TD sont tirés de l'excellent livre "Tête la première : Design Pattern".
Bert Bates, Eric Freeman, Elisabeth Freeman, Kathy Sierra. Editions O'Reilly. 2005.

image::headFirst.jpg[link="https://www.oreilly.com/library/view/head-first-design/0596007124/",width=40%]
=====

=== Problème initial

Vous participez au développement d'un simulateur de fabriques de chocolat modernes dont des bouilleurs sont assistés par ordinateur.

La tâche du bouilleur consiste à contenir un mélange de chocolat et de lait, à le porter à ébullition puis à le transmettre à la phase suivante où il est transformé en plaquettes de chocolat.

Ce comportement peut se représenter par la machine à état suivante:

.Machine à état des bouilleurs (source link:images/stateMachine.plantuml[ici])
image::stateMachine.svg[]

Voici la classe contrôleur du bouilleur industriel de _Bonchoco, SA_.

.Contrôleur du bouilleur en Java
[source,java]
------
public class BouilleurChocolat {
	private boolean vide;
	private boolean bouilli;

	public BouilleurChocolat() {
		vide = true;
		bouilli = false;
	}

	public void remplir() {
		if (estVide()) {
			vide = false;
			bouilli = false;
			// remplir le bouilleur du mélange lait/chocolat
		}
	}

	public void vider() {
		if (!estVide() && estBouilli()) {
			// vider le mélange
			vide = true;
		}
	}

	public void bouillir() {
		if (!estVide() && !estBouilli()) {
			// porter le contenu à ébullition
			bouilli = true;
		}
	}

	public boolean estVide() { return vide;}

	public boolean estBouilli() { return bouilli;}
}
------

//----------------------------- Question ------------------
.*QUESTION*
[WARNING]
====
. À quoi servent les attributs `vide` et `bouilli`?
====
//----------------------------------------------------- Correction -------------------------
ifdef::prof[]
.Solution image:icons/solution.png[]
[CAUTION]
====
Si vous étudiez le code, vous constatez qu'ils ont essayé très soigneusement d'éviter
les catastrophes, par exemple de vider deux mille litres de mélange qui n'a pas bouilli,
de remplir un bouilleur déjà plein ou de faire bouillir un bouilleur vide !
====
endif::prof[]
//----------------------------------------------------- fin Correction -------------------------

Vous faîtes un cauchemar horrible (quoique) où vous vous noyez dans du chocolat.
Vous vous réveillez en sursaut avec une crainte terrible.


//----------------------------- Question ------------------
.*QUESTION*
[WARNING]
====
. Que pourrait-il se passer avec plusieurs instances de contrôleurs (pour un seul et même bouilleur)?
+
Pour tester ce scénario, exécutez le test unitaire JUnit `twoChocolateBoilersMightBlowTheFactory` fourni dans votre repo :
+
.Un test qui ne devrait pas échouer
image::failingTest.png[]
+
. De quoi faudrait-il s'assurer pour éviter ce problème?
. Trouvez des exemples de situations où il est important de n'avoir
qu'une seule instance d'une classe donnée.
====
//----------------------------------------------------- Correction -------------------------
ifdef::prof[]
.Solution image:icons/solution.png[]
[CAUTION]
====
. Que l'un remplisse alors que l'autre n'a pas vidé par exemple.
. S'assurer de n'avoir qu'une seule instance de ce contrôleur.
. Quelques exemples :
- accès unique à une base de données (on vient de le voir)
- objet "parent" d'une interface
- ...
====
endif::prof[]
//----------------------------------------------------- fin Correction -------------------------

=== Amélioration 1

Vous vous souvenez des premiers exercices {java}  sur les variables de classe et vous proposez d'utiliser un compteur d'instance pour solutionner le problème.

//----------------------------- Question ------------------
.*QUESTION*
[WARNING]
====
Vous essayez de modifier le constructeur pour qu'il ne fonctionne que si le compteur d'instance est à 0.
Qu'est-ce qui ne va pas dans l'extrait de code suivant :

.BouilleurCptChocolat.java
[source,java]
-----
public class BouilleurCptChocolat { 
	private boolean vide;
	private boolean bouilli; 
	private static int nbInstance = 0;

	public BouilleurCptChocolat() {
		vide = true;
		bouilli = false;
		if (nbInstance == 0) {
			nbInstance = 1;
			return this;
		}
		else {
			return null;
		}
...
-----
====
//----------------------------------------------------- Correction -------------------------
ifdef::prof[]
[CAUTION]
====
Pas de return dans un constructeur.
====
endif::prof[]
//----------------------------------------------------- fin Correction -------------------------

=== Amélioration 2

Vous changez de stratégie car vous vous souvenez avoir déjà vu ce type de code :

.Idée!
[source,java]
------
public class MaClasse {
	private MaClasse() {...}
}
------

//----------------------------- Question ------------------
.*QUESTION*
[WARNING]
====
. Est-ce autorisé de rendre privé le constructeur?
. Comment créer une instance dans ces conditions? N'a-t'on pas tout simplement une classe inutilisable?
====

//----------------------------------------------------- Correction -------------------------
ifdef::prof[]
[CAUTION]
====
. Oui!
. En implémentant une fonction qui s'en charge.
====
endif::prof[]
//----------------------------------------------------- fin Correction -------------------------


//----------------------------- Question ------------------
.*TODO*:
[WARNING]
====
[%interactive]
* [ ] Complétez le code suivant de façon à résoudre le problème :
+
.BouilleurSafeChocolat
[source,java]
-----
public class BouilleurSafeChocolat {
	private boolean vide;
	private boolean bouilli;
	...
	...

	        BouilleurChocolat() {
		...
		...
		}

	...
	...
	...
	...

	public void remplir() {
		if (estVide()) {
			vide = false;
			bouilli = false;
			// remplir le bouilleur du mélange lait/chocolat }
		}
		// reste du code de BouilleurChocolat...
}
-----
+
* [ ] Ecrivez un test qui utilise cette classe
* [ ] Modifiez le test unitaire JUnit `twoChocolateBoilersMightBlowTheFactory` et vérifiez qu'il passe cette fois :
+
.Un test qui n'échoue plus
image::passingTest.png[]

* [ ] Quand tout est OK, push votre code :
+
ifndef::backend-pdf[.pass:[<i class="fa fa-github"></i>] commit/push]
ifdef::backend-pdf[.icon:github[] commit/push]
[source,shell]
....
fix #1.3 Solution with a private constructor
....
+
- [ ] Vérifiez le statut du commit
+
.Get details on success :-)
image::autogradingOK.png[width=80%]
====

=== C'est pas fini!

Vos cauchemars continuent! 

//----------------------------- Question ------------------
.*QUESTION*
[WARNING]
====
. En quoi les _threads_ peuvent-ils poser des problèmes dans votre solution?
. Recopiez sur des bouts de feuilles les fragments de code ci-dessous en les
plaçant dans les colonnes du tableau suivant pour mettre en évidence le
problème en reconstituant un enchaînement erroné possible avec deux threads.
:
+
[cols="3"]
|===
|*Thread 1*
|*Thread 2*
|*Valeur de `uniqueInstance`*
|||
|||
|||
|||
|||
|||
|||
|||
|||
|||
|||
|||
|||
|||
|||
|||
|===
====

.Bloc 1
[source,java]
------
public static BouilleurChocolat getInstance() {
------

.Bloc 2
[source,java]
------
if (uniqueInstance == null) {
------

.Bloc 3
[source,java]
------
uniqueInstance = new BouilleurSafeChocolat();
------

.Bloc 4
[source,java]
------
		}
------

.Bloc 5
[source,java]
------
		return uniqueInstance;
------

.Bloc 6
[source,java]
------
	}
------

//----------------------------------------------------- Correction -------------------------
ifdef::prof[]
[CAUTION]
====
.Solution (source <<Freeman05>>)
image::thread-sol.png[]

[source,java,linenums]
------
public class BouilleurSafeChocolat {
	private boolean vide;
	private boolean bouilli;
	private static BouilleurSafeChocolat uniqueInstance;

	private BouilleurSafeChocolat() {
	  vide = true;
	  bouilli = false;
	}

	public static final BouilleurSafeChocolat getInstance() {
	  if (uniqueInstance == null) {
        uniqueInstance = new BouilleurSafeChocolat();
	  }
	  return uniqueInstance;
	}
------

Explications :

. Thread 1 appelle `getInstance()` et détermine que `uniqueInstance` est `null` en ligne 12
. Thread 1 entre dans le bloc `if` puis est préempté par le thread 2 avant
l'exécution de la ligne 13
. Thread 2 appelle `getInstance()` et détermine que `uniqueInstance` est `null` en ligne  12
. Thread 2 entre dans le bloc `if`, crée un nouveau `BouilleurSafeChocolat` et
assigne ce nouvel objet à la variable `uniqueInstance` en ligne  13
. Thread 2 retourne la référence au `BouilleurSafeChocolat` en ligne  15
. Thread 2 est préempté par le Thread 1
. Thread 1 reprend où il s'était arrêté et exécute la ligne 13 créant alors une autre instance de `BouilleurSafeChocolat`
. Thread 1 retourne cette nouvelle instance en ligne  15

====

endif::prof[]
//----------------------------------------------------- fin Correction -------------------------

=== Solution au multithreading

Vous vous souvenez heureusement de vos cours de début d'année sur les _threads_ :

//----------------------------- Question ------------------
.*QUESTION*
[WARNING]
====
. Proposez une solution simple à ce problème.
====
//----------------------------------------------------- Correction -------------------------
ifdef::prof[]
[CAUTION]
=====
Il suffit de faire de `getInstance()` une méthode *synchronisée* :
[source,java]
------
public class BouilleurSafeChocolat {
  private boolean vide;
  private boolean bouilli;
  private static BouilleurSafeChocolat uniqueInstance;

  private BouilleurSafeChocolat() {
    vide = true;
    bouilli = false;
  }

  public static synchronized BouilleurSafeChocolat getInstance() {
    if (uniqueInstance == null) {
      uniqueInstance = new BouilleurSafeChocolat();
    }
    return uniqueInstance;
  }
------
=====
endif::prof[]
//----------------------------------------------------- fin Correction -------------------------

=== Problème de la solution!!

//----------------------------- Question ------------------
.*QUESTION*
[WARNING]
====
. Combien de fois le mécanisme mis en place va-t'il être utile ?
. Que pensez-vous alors de cette solution ?
. Proposez une solution où l'instance est créé au démarrage plutôt qu'à la demande.
====
//----------------------------------------------------- Correction -------------------------
ifdef::prof[]
[CAUTION]
=====
. Une seule fois, lors du 1er passage dans la méthode!!
. C'est bien trop consomateur en ressource! En pratique, il y a des copies de blocs de mémoire, ce qui prend du temps.

. Voici un exemple :
+
.Création de l'instance unique au démarrage
[source,java]
------
public class Singleton {
	private static final Singleton uniqueInstance = new Singleton();
	private Singleton() {}
	public static Singleton getInstance() { return uniqueInstance;}
}
------
+
En adoptant cette approche, nous nous reposons sur la JVM pour créer l'unique instance du Singleton quand la classe est chargée.
La JVM garantit que l'instance sera créée avant qu'un thread quelconque n'accède à la variable statique `uniqueInstance`.

=====
endif::prof[]
//----------------------------------------------------- fin Correction -------------------------

WARNING: Il peut y avoir des situations où le coût de la synchronisation est inférieur au coût de créer dès le départ une instance (par exemple gourmande en mémoire).

[[Singleton]]
== Singleton

Félicitations, vous venez de mettre en oeuvre votre deuxième patron, le *Singleton*.

[NOTE]
.Design pattern : *Singleton*
====
*Singleton* garantit qu'une classe n'a qu'une seule instance et
fournit un point d'accès global à cette instance.


ifndef::slides[.Modèle UML du patron _Singleton_]
image::singleton.svg[]
====

ifdef::prof[]
.Quelques exemples de description du patron Singleton
image::google-singleton.png[link="images/google-singleton.png"]
endif::prof[]

== Le singleton pour le jeu d'aventure

=== Combiner plusieurs patrons?

Peut-on combiner les deux derniers patrons vus en TD (_Strategy_ et Singleton)?
En effet, les comportements sont portés par des objets pour l'aspect algorithme, mais il n'y a pas de raison de ne pas les partager entre tous les objets qui "utilisent" ce comportement?!

ifndef::compact[]
[NOTE]
=======
endif::compact[]
Dans la plupart des cas ces deux patrons ne vont *pas du tout ensemble*.
Cette stratégie n'est recommandée que dans un cas bien précis d'utilisation de _Strategy_ : celui où les comportements sont simples et "statiques" (pas de consommation de ressources par exemple) et où l'on utilise une association :

image::strategy-assoc.png[]

Avec une implémentation du type :

[source,java]
------
...
vol = new VolerAvecDesAiles();
cri = new Cancan();
c1 = new Colvert(vol,cri);
...
------
ifndef::compact[]
=======
endif::compact[]

=== Et si on améliorait le jeu d'aventure avec Singleton?

//----------------------------- Question ------------------
.*QUESTION*
[WARNING]
====
. Faites en sorte que les instances d'objet affectées à chaque comportement
d'un `Personnage` soient uniques pour chaque comportement distinct.
. Pourquoi ne devrait-on pas utiliser `getInstance()` dans le cas
d'une composition (dans le constructeur du composé) ?
====

NOTE: On voit que ce n'est pas toujours évident de combiner les patrons entre eux.

:numbered!:
== {allerPlusLoin}

//----------------------------- Question ------------------
.*QUESTION*
[WARNING]
====
. Quelle est la différence entre un singleton et une variable globale?
. Comment testeriez-vous la mise en oeuvre du patron <<Singleton,Singleton>>?
====
//----------------------------------------------------- Correction -------------------------
ifdef::prof[]
[CAUTION]
====
Quelques éléments de solution :

- En {java} les variables globales sont des références statiques à des objets.
- Problème déjà vu de l'instanciation à la demande vs. au démarrage.

Exemples de test :

- Tentative d'instanciation depuis l'extérieur de la classe
- Tentative de construction de deux objets de type Singleton

====
endif::prof[]
//----------------------------------------------------- fin Correction -------------------------

//----------------------------- Question ------------------
.*QUESTION*
[WARNING]
====
Il existe une autre façon de gérer le problème du multithreading. Cherchez sur Internet les articles sur le "verrouillage à double vérification" (qui ne fonctionne que depuis Java `1.5`).
====

[TIP]
====
N'hésitez pas à consulter les liens suivants :

- http://christophej.developpez.com/tutoriel/java/singleton/multithread/
====


//------------------------------------ 
== Ressources
//------------------------------------ 

Mise en place de l'environnement Eclipse:

- Créez un nouveau répertoire (disons `TD2`)
- Dans ce dossier ouvrez un git bash
- git clone http://urlduprojet
- Ouvrez eclipse, changez de workspace, sélectionnez le dossier `TD2`
- Une fois le workspace ouvert, cliquez sur menu:File[Import > General > Existing Projects into Workspace] puis `Next`
- menu:Select root directory[Browse], sélectionnez ce repo (`urlduprojet` dans cet example)
- Cliquez sur menu:Finish[]

Installation de Maven sous Windows:

- Télécharger: https://apache.mediamirrors.org/maven/maven-3/3.6.3/binaries/apache-maven-3.6.3-bin.zip
- Décompresser le contenu dans `C:\Programmes\Java`
- Dans Menu Démarrer, taper `Environnement` puis cliquer sur menu:Modifier les variables d'environnement système[]
- Cliquer sur `Variables d'environnement`
- Dans la section `Variables système`, sélectionner `Path`, cliquer sur `Modifier`
- Cliquez sur `Nouveau`, puis saisissez `C:\Program Files\Java\apache-maven-3.6.3\bin` (vérifiez que le dossier existe)
- Cliquez successivement 3 fois sur "OK".
- La commande MVM devrait être disponible dans un cmd windows (fermer les existants)


//------------------------------------ 
== Contributeurs
//------------------------------------ 

- mailto:jbruel@gmail.com[Jean-Michel Bruel]
- mailto:louis@chanouha.fr[Louis Chanouha]


== {about}

****************************************************************
Document réalisé via  {asciidoctorlink} (version `{asciidoctor-version}`) de 'Dan Allen', lui même basé sur {asciidoc}.
Libre d'utilisation et géré par la 'Licence Creative Commons'.
image:88x31.png["Licence Creative
Commons",style="border-width:0",link="http://creativecommons.org/licenses/by-sa/3.0/"]
http://creativecommons.org/licenses/by-sa/3.0/[licence Creative Commons Paternité - Partage à l&#39;Identique 3.0 non transposé].
****************************************************************